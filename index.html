<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çµµæ–‡å­—ä»•åˆ†ã‘</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #F8FAFC; font-family: sans-serif; }
        canvas { display: block; }
    </style>
</head>
<body>
<script>
// --- ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿è¨­å®š ---
let stages = [
  { pair: ["ğŸ‘", "â˜ï¸"], goal: 5, bgL: "#FFDEE9", bgR: "#B5FFFC", speed: 2.5, span: 75 },
  { pair: ["â­", "ğŸŒ™"], goal: 7, bgL: "#D1D5DB", bgR: "#93C5FD", speed: 3.0, span: 65 },
  { pair: ["ğŸ§Š", "ğŸ•¯ï¸"], goal: 8, bgL: "#FED7AA", bgR: "#FEE2E2", speed: 3.5, span: 55 },
  { pair: ["ğŸ«§", "ğŸ¬"], goal: 10, bgL: "#BFDBFE", bgR: "#DBEAFE", speed: 4.0, span: 45 },
  { pair: ["ğŸ€", "ğŸ§¸"], goal: 12, bgL: "#DDD6FE", bgR: "#F5D0FE", speed: 4.5, span: 40 },
  { pair: ["â˜„ï¸", "ğŸª"], goal: 15, bgL: "#312E81", bgR: "#4C1D95", speed: 5.0, span: 35 },
  { pair: ["ğŸƒ", "ğŸ"], goal: 13, bgL: "#DCFCE7", bgR: "#BBF7D0", speed: 5.5, span: 32 },
  { pair: ["âœ¨", "ğŸ’"], goal: 11, bgL: "#E0F2F1", bgR: "#B2DFDB", speed: 6.0, span: 30 },
  { pair: ["ğŸƒ", "ğŸ‘»"], goal: 14, bgL: "#1F2937", bgR: "#4B5563", speed: 6.5, span: 28 },
  { pair: ["ğŸŒ¦ï¸", "ğŸŒˆ"], goal: 20, bgL: "#FDF2F8", bgR: "#E0F2F1", speed: 7.0, span: 25 }
];

let badEmoji = "ğŸ¥º";
let gameTitle = "çµµæ–‡å­—ä»•åˆ†ã‘"; 
let currentStage = 0;
let isChaosMode = false; 
let targetEmoji, otherEmoji, targetSide;
let targetCount, gameState = "START";
let leftStack = [], rightStack = [], particles = [];
let activeEmojis = [];
let spawnTimer = 0;
let startTime, totalScore = 0;
let highScores = [];
let chaosSpeed = 2.5; 
let chaosSpan = 75;
let lives = 3;
let maxLives = 3;

function setup() {
  createCanvas(windowWidth, windowHeight);
  textAlign(CENTER, CENTER);
  let saved = localStorage.getItem('emojiSortingRanking');
  if (saved) highScores = JSON.parse(saved);
  initStage();
}

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
}

function draw() {
  if (gameState === "START") drawStartScreen();
  else if (gameState === "PLAY") drawGamePlay();
  else if (gameState === "STAGE_CLEAR") drawFeverScreen();
}

function drawStartScreen() {
  background("#F8FAFC");
  fill(71, 85, 105);
  textSize(min(width * 0.1, 50));
  textStyle(BOLD);
  text(gameTitle, width / 2, height * 0.12);
  drawVisualManual();
  let btnY = height * 0.72;
  fill("#64748B");
  noStroke();
  rectMode(CENTER);
  rect(width / 2, btnY, 220, 70, 20);
  fill(255);
  textSize(24);
  textStyle(NORMAL);
  text("GAME START", width / 2, btnY + 2);
  rectMode(CORNER);
  fill(148, 163, 184);
  textSize(14);
  text("ğŸ† TOP RECORDS", width / 2, height * 0.82);
  for (let i = 0; i < 5; i++) {
    let entry = highScores[i] ? `${highScores[i].score} pts (Lv.${highScores[i].lv})` : "---";
    text(entry, width / 2, height * 0.85 + (i * 20));
  }
}

function drawVisualManual() {
  let panelW = width * 0.28;
  let panelH = height * 0.3;
  let startY = height * 0.25;
  let spacing = width * 0.32;
  drawPanel(width/2 - spacing, startY, panelW, panelH, "1.ä»•åˆ†ã‘", "å·¦å³ã‚’ã‚¿ãƒƒãƒ—", "ğŸ‘ˆ ğŸ ğŸ ğŸ‘‰");
  drawPanel(width/2, startY, panelW, panelH, "2.ç¢ºå®š", "æ•°ãˆã¦ãƒœã‚¿ãƒ³", "5 / 5 [ç¢ºå®š]");
  drawPanel(width/2 + spacing, startY, panelW, panelH, "3.ãŠé‚ªé­”", "ğŸ¥ºã‚’ã‚¿ãƒƒãƒ—", "ğŸ’¥ ğŸ¥º ğŸ’¥");
}

function drawPanel(x, y, w, h, title, sub, visual) {
  push();
  translate(x, y + h/2);
  fill(255);
  stroke(226, 232, 240);
  strokeWeight(2);
  rectMode(CENTER);
  rect(0, 0, w, h, 15);
  noStroke();
  fill(100);
  textSize(14);
  textStyle(BOLD);
  text(title, 0, -h/2 + 25);
  fill(130);
  textSize(11);
  textStyle(NORMAL);
  text(sub, 0, -h/2 + 45);
  fill(71, 85, 105);
  textSize(w * 0.2);
  text(visual, 0, 15);
  pop();
}

function drawGamePlay() {
  let s = isChaosMode ? {bgL:"#000", bgR:"#111", speed:chaosSpeed, span:chaosSpan} : stages[currentStage];
  noStroke();
  fill(s.bgL); rect(0, 0, width/2, height);
  fill(s.bgR); rect(width/2, 0, width/2, height);
  fill(255, 200); rect(width*0.05, 30, width*0.9, 140, 20);
  textSize(24);
  let heartText = "";
  for(let i=0; i<maxLives; i++) heartText += (i < lives) ? "â¤ï¸" : "ğŸ–¤";
  text(heartText, width/2, height - 140);
  fill(71, 85, 105);
  let lvLabel = isChaosMode ? "CHAOS MODE" : "Level " + (currentStage + 1);
  textSize(16); text(lvLabel, width/2, 55);
  textSize(18);
  let leftT = (targetSide === "LEFT") ? "æ•°ãˆã‚‹: " + targetEmoji : otherEmoji;
  let rightT = (targetSide === "RIGHT") ? "æ•°ãˆã‚‹: " + targetEmoji : otherEmoji;
  text("â† " + leftT, width*0.25, 85);
  text(rightT + " â†’", width*0.75, 85);
  textSize(22); textStyle(BOLD);
  if (isChaosMode) {
    fill("#ff4d4d");
    text(targetEmoji + " ã‚’ãƒŸã‚¹ã™ã‚‹ã¾ã§ä»•åˆ†ã‘ï¼", width/2, 125);
  } else {
    fill(71, 85, 105);
    text(targetEmoji + " ã‚’ [ " + stages[currentStage].goal + " ] å€‹æ•°ãˆã‚‹", width/2, 125);
  }
  textStyle(NORMAL);
  handleActiveEmojis();
  drawStacks();
  rectMode(CENTER);
  fill(71, 85, 105); rect(width/2, height - 70, 140, 55, 15);
  fill(255); textSize(20); text("ç¢ºå®š", width/2, height - 68);
  rectMode(CORNER);
}

function handleActiveEmojis() {
  let s = isChaosMode ? {speed:chaosSpeed, span:chaosSpan, pair:["ğŸ”¥","ğŸ’€"]} : stages[currentStage];
  spawnTimer++;
  if (spawnTimer >= s.span) {
    let r = random();
    let emoji = (r < 0.25) ? badEmoji : (random() > 0.5 ? s.pair[0] : s.pair[1]);
    activeEmojis.push({ emoji: emoji, x: random(width*0.1, width*0.9), y: -100, size: width * 0.2 });
    spawnTimer = 0;
  }
  for (let i = activeEmojis.length - 1; i >= 0; i--) {
    let e = activeEmojis[i];
    textSize(e.size); text(e.emoji, e.x, e.y);
    e.y += s.speed;
    if (e.y > height + 100) {
      if (e.emoji === badEmoji) reduceLife("ğŸ¥ºã‚’è¦‹é€ƒã—ã¾ã—ãŸï¼");
      activeEmojis.splice(i, 1);
    }
  }
}

function drawStacks() {